name = "jack-control"
main = "src/index.ts"
compatibility_date = "2024-12-01"

[ai]
binding = "AI"

routes = [
  { pattern = "control.getjack.org", custom_domain = true }
]

[triggers]
crons = ["*/1 * * * *"]

[[d1_databases]]
binding = "DB"
database_name = "jack-control-db"
database_id = "06431345-a970-42e2-86ab-fea5bce98dc0"

[[kv_namespaces]]
binding = "PROJECTS_CACHE"
id = "1745e7c2b059484c81d39c694201d061"

[[r2_buckets]]
binding = "CODE_BUCKET"
bucket_name = "jack-code-internal"

[[queues.producers]]
binding = "ASK_INDEX_QUEUE"
queue = "ask-index-jobs"

[[queues.consumers]]
queue = "ask-index-jobs"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 4

[[dispatch_namespaces]]
binding = "TENANT_DISPATCH"
namespace = "jack-tenants"

[durable_objects]
bindings = [
  { name = "LOG_STREAM", class_name = "LogStreamDO" }
]

[[migrations]]
tag = "logstream-v1"
new_classes = ["LogStreamDO"]

[[unsafe.bindings]]
name = "FEEDBACK_LIMITER"
type = "ratelimit"
namespace_id = "1001"
simple = { limit = 5, period = 60 }

[[unsafe.bindings]]
name = "USERNAME_CHECK_LIMITER"
type = "ratelimit"
namespace_id = "1002"
simple = { limit = 30, period = 60 }

# Analytics Engine for querying usage data
# Same dataset that dispatch worker writes to
[[analytics_engine_datasets]]
binding = "USAGE"
dataset = "jack_usage"

# Analytics Engine dataset for control-plane feature usage
[[analytics_engine_datasets]]
binding = "CONTROL_USAGE"
dataset = "jack_control_usage"

# Note: Run `wrangler d1 create jack-control-db` first
# Then add the database_id here
# Secrets (set via wrangler secret put <NAME>):
# - WORKOS_API_KEY
# - CLOUDFLARE_API_TOKEN
# - CLOUDFLARE_ACCOUNT_ID
# - CLOUDFLARE_ZONE_ID
# - STRIPE_SECRET_KEY      # Stripe API secret key (sk_live_xxx or sk_test_xxx)
# - STRIPE_WEBHOOK_SECRET  # Stripe webhook signing secret (whsec_xxx)
# - DAIMO_API_KEY          # Daimo API key (from Daimo team)
# - DAIMO_WEBHOOK_SECRET   # Daimo webhook basic auth token
# - DAIMO_RECEIVER_ADDRESS # Wallet address to receive USDC on Base
# - POSTHOG_API_KEY        # Optional: server-side product analytics capture
